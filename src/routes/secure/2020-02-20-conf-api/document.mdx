### 目标

- 将现有配置后台的配置数据对外提供api，可以进行查询、新建、编辑、发布
- 提供一种高效的缓存机制，尽可能将查询服务通过缓存来匹配

### 技术架构

![wax-papaya_配置化服务](https://github.com/wulucxy/blog/tree/master/src/routes/secure/2020-02-20-conf-api/image/api.png)

### 一些要点

1. 对外 api 统一不做用户认证，但是为了保证能够获取到用户信息，统一约定以 `x-login-user` 为统一用户标识
2. 外部操作允许配置新建、编辑，发布，其中发布的权限统一收拢到 wups 权限中心进行管理
3. 本项目接口 url 统一前缀为`/conf-web/api`
4. 发布的权限和审核考虑放到二期来实现

### api 接口地址

- 测试环境：
- 生产环境：

### api 设计

#### 查询应用列表

- 查询应用列表，将返回的应用 `[{name, code, id}]` 缓存到 redis，key 值 `${appPrefix}_appList`
- 配置后台每次新建配置删除缓存，等待下一次访问
- 考虑到应用数量目前不会太多，目前不做分页处理

| router   |  请求参数   |  返回结果  | 
| --------   | -----  |  ----   | 
|  GET: /public/app/list     |    |   [{id, code, name}]   |

#### 查询配置

- 基于单配置编码，或是配置编码列表查询（如果是查询字符串，会转成字符串数组查询）
- 首次从 db 查询获取的数据通过 `${configPrefix}_${appCode}_${configCode}` 缓存到 redis
- 后续查询首先获取缓存数据，如果取不到就从 db 查询，并写入缓存
- 每次配置重新发布以后删除缓存，等待下一次请求查询
- 配置查询完毕写入`cacheInfo`，用于查询全部缓存信息: todo

**cacheInfo 信息**

```
{
  app1: ['config1', 'config2'],
  app2: ['config3', 'config4']
}
```

| router   |  请求参数   |  返回结果  | 
| --------   | -----  |  ----   | 
|  POST: /public/config/search     |  {codeList: ['code1', 'code2']}  |   [{code: 'aaa', value: 'bbbb'}]   |

#### 基于应用查询配置列表

- 通过应用编码（appCode）来查询指定应用下的配置列表
- 将查询获取的配置列表缓存到 `${configPrefix}_${appCode}` key 值
- 每次发布对应应用下配置时移除缓存

| router   |  请求参数   |  返回结果  | 
| --------   | -----  |  ----   | 
|  GET: /public/config/searchByApp     |  {appCode}  | [{code: 'aaa', value: 'bbbb'}]   |

#### 新建配置

- 新建配置需要检查配置编码是否唯一

| router   |  请求参数   |  返回结果  | 
| --------   | -----  |  ----   | 
|  POST: /public/config/create     |  {name, code, appCode, value, groupId?, desc?}  |   {id, code, name, value, desc, version, status, app}   |

#### 编辑配置

- 编辑配置需要检查配置 id 是否存在

| router   |  请求参数   |  返回结果  | 
| --------   | -----  |  ----   | 
|  POST: /public/config/edit     |  {id, value?, name?, desc?}  |   {code: 0}   |

#### 新建配置草稿

| router   |  请求参数   |  返回结果  | 
| --------   | -----  |  ----   | 
|  POST: /public/config/draft     |  {id}  |   {code: 0}   |

#### 新建草稿和编辑内容合并

| router   |  请求参数   |  返回结果  | 
| --------   | -----  |  ----   | 
|  POST: /public/config/draftThenEdit     |  {id, value?, name?, desc?}  |   {code: 0}   |

#### 发布配置

- 编辑配置需要检查配置 id 是否存在

| router   |  请求参数   |  返回结果  | 
| --------   | -----  |  ----   | 
|  POST: /public/config/publish     |  {id}  |   {code: 0}   |

![publish](https://github.com/wulucxy/blog/tree/master/src/routes/secure/2020-02-20-conf-api/image/auth.png)

### 以下不对外部用户开放，用于平台管理

#### 查看平台配置缓存信息

| router   |  请求参数   |  返回结果  | 
| --------   | -----  |  ----   | 
|  GET: /dev/cache/info     |   |   见 `cacheInfo`   |

#### 删除应用缓存

| router   |  请求参数   |  返回结果  | 
| --------   | -----  |  ----   | 
|  POST: /dev/cache/app/delete     |   |   {code: 0}  |

#### 删除配置缓存

- 基于应用编码和配置编码查询对应的缓存

| router   |  请求参数   |  返回结果  | 
| --------   | -----  |  ----   | 
|  POST: /dev/cache/config/delete     |  {codeList: `string[], string`}  |   {code: 0}  |

#### 删除应用下所有配置缓存

- 基于应用编码和配置编码查询对应的缓存

| router   |  请求参数   |  返回结果  | 
| --------   | -----  |  ----   | 
|  POST: /dev/cache/config/deleteByAppCode     |  {appCode}  |   {code: 0}  |



