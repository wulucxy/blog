## 从依赖注入说起

```javascript
class A {
  constructor() {
    this.b = new B()
  }
  
  foo() {
    // do something
    this.b.xxx()
  }
}

class B {}
```

A 模块依赖 B 模块，直接引用了 B 模块的实现。

有一天事情发生了变化，B 模块更新了 or 有其他的条件判断了，导致 A 模块也需要修改

> 面向对象的五个基本原则:SOLID
>
> **依赖反转**：依赖于抽象而不是一个实例

### 注入的几种模式

- 构造函数注入

  ```javascript
  class A { constructor(b) { this.b = b }  }
  var b = new B()
  var a = new A(b)
  ```

- 属性注入

  ```javascript
  class A { constructor() { this.b = defaultB } setB(b){ this.b = b } }
  var a = new A()
  var b = new B()
  a.setB(b)
  ```

- 接口注入

  js 里不存在接口的概念，不展开讨论。可以参考静态语音，如 java 的 IOC 容器

## HOF 函数级别上的依赖注入

类似“工厂”模式

```javascript
function createA = b => new A(b)
const a1 = createA(b1)
const a1 = createA(b2)
```

## 示例

### papaya-request 依赖 axios，需要改造为 hakone

改造前，直接在中间件中依赖 axios

<http://git.caimi-inc.com/client/papaya-request/blob/28d1f8d4d9da37357d7b950bc08ab680b83ab0f5/src/index.js>

改造思路：直接替换 axios 为 hakone

更深入的思考：hakone 是 axios 的一种实现，request 可以接受任何 axios 的实例

面向接口编程，注入 axios 实例

实际改造：使用高阶函数注入

<http://git.caimi-inc.com/client/papaya-request/blob/master/src/create-request.js>

### papaya-auth 依赖 axios

历史背景，auth 为何不依赖 request

淮南子的述求：配置请求参数：添加了 axiosOptions 属性

<http://git.caimi-inc.com/client/papaya-auth/merge_requests/36/diffs>

问题：和 request 的实现存在不一致，使用了 构造函数注入，未提供 createAuthService 函数

## 单元测试中的 mock

代码耦合严重难以测试，

<http://git.caimi-inc.com/client/papaya-auth/blob/badab74346972838fc5889e502a72839773efc7e/src/auth-service/axios.js>

```javascript
const axios = require('axios')
const instance = axios.create()

instance.interceptors.response.use(
  response => { },
  err => { }
)

module.exports = instance
```

改造之后的版本

```javascript
module.exports = [
  response => { },
  err => { }
]
```

## 课后习题

- papaya-proxy 依赖的 papaya-request，papaya-uploader

- node serverice 依赖 ctx 中的 fetch、log，如何改造？

```javascript
module.exports = async (ctx) => {
  const service = new Service(ctx)
}

class Service {
  constructor (ctx) {
    this.ctx = ctx
    this.fetch = ctx.fetch
  }

  async getItem (qs) {
    return this.fetch({ 'applist/list', qs }).catch(e => ctx.log(e))
  }
}
```

- 了解 AOP、IOC、IOC Container 等概念
- 了解 angular 的依赖注入实现